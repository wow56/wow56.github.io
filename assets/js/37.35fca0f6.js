(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{506:function(s,a,t){"use strict";t.r(a);var e=t(48),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"git-安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#git-安装"}},[s._v("#")]),s._v(" Git 安装")]),s._v(" "),t("blockquote",[t("p",[s._v("该章节包括 Git 以及与 Git 相关的一些工具的安装，例如 GitLab 的部署配置等。")])]),s._v(" "),t("h2",{attrs:{id:"参考文档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考文档"}},[s._v("#")]),s._v(" 参考文档")]),s._v(" "),t("h2",{attrs:{id:"gitlab-安装配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-安装配置"}},[s._v("#")]),s._v(" GitLab 安装配置")]),s._v(" "),t("h3",{attrs:{id:"linux-安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#linux-安装"}},[s._v("#")]),s._v(" Linux 安装")]),s._v(" "),t("h3",{attrs:{id:"docker-安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-安装"}},[s._v("#")]),s._v(" Docker 安装")]),s._v(" "),t("p",[s._v("启动容器：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("docker run -id "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --hostname 配置容器的主机名称，gitlab 如果不配置服务地址，默认可能会使用 hostname 配置。")]),s._v("\n--hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".5.11 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口映射，-p 80:80 可以简写 -p 80")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 443 https 80 http 22 ssh")]),s._v("\n-p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(":443 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":80 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5622")]),s._v(":22 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n--name gitlab-ce "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将数据卷映射到 /srv 服务目录下")]),s._v("\n-v /srv/docker/gitlab/config/:/etc/gitlab  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n-v /srv/docker/gitlab/logs:/var/log/gitlab  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-v /srv/docker/gitlab/data/:/var/opt/gitlab   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以只读（ro）方式绑定宿主机与容器时间")]),s._v("\n-v /etc/localtime:/etc/localtime:ro "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 镜像名")]),s._v("\ngitlab/gitlab-ce:17.7.0-ce.0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("h3",{attrs:{id:"gitlab-备份与恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-备份与恢复"}},[s._v("#")]),s._v(" GitLab 备份与恢复")]),s._v(" "),t("blockquote",[t("p",[s._v("这两个命令用于 docker 部署时")]),s._v(" "),t("p",[s._v("gitlab-backup create 即 "),t("code",[s._v("docker exec -t gitlab-ce gitlab-backup create")])]),s._v(" "),t("p",[s._v("gitlab-bakcup restore BACKUP=[timestamp] 即 "),t("code",[s._v("docker exec -t gitlab-ce gitlab-bakcup restore BACKUP=[timestamp]")])])]),s._v(" "),t("ol",[t("li",[t("p",[t("strong",[s._v("手动创建一次备份")]),s._v("（用于验证命令是否正常工作）")]),s._v(" "),t("p",[s._v("使用 "),t("code",[s._v("docker exec")]),s._v(" 命令进入容器并执行备份：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -t gitlab-ce gitlab-backup create\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这将在容器内的 "),t("code",[s._v("/var/opt/gitlab/backups/")]),s._v(" 目录下创建一个备份文件。")])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("将备份文件保存到主机")])]),s._v(" "),t("p",[s._v("因为你的容器已经挂载了卷 "),t("code",[s._v("/srv/docker/gitlab/data/:/var/opt/gitlab")]),s._v("，所以任何在容器内 "),t("code",[s._v("/var/opt/gitlab/backups/")]),s._v(" 下创建的文件都会自动同步到主机的 "),t("code",[s._v("/srv/docker/gitlab/data/backups/")]),s._v(" 目录。")])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("设置定时任务")])]),s._v(" "),t("p",[s._v("在 Docker 主机上编辑 crontab 文件，添加一个定时任务来每天创建一次备份：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("crontab")]),s._v(" -e\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("添加一行类似以下内容（假设你想每天凌晨2点执行备份）：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" * * * docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -t gitlab-ce gitlab-backup create "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CRON")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("code",[s._v("CRON=1")]),s._v(" 参数会使得输出更简洁，并且不会发送邮件通知。")])])]),s._v(" "),t("p",[s._v("在GitLab的配置文件"),t("code",[s._v("/etc/gitlab/gitlab.rb")]),s._v("中，有专门用于配置备份设置的部分。这些设置可以影响到备份的位置、频率以及保留策略等。以下是一些常用的与备份相关的配置项：")]),s._v(" "),t("p",[t("strong",[s._v("备份存储位置")])]),s._v(" "),t("p",[s._v("默认情况下，GitLab会将备份文件保存在容器内部的 "),t("code",[s._v("/var/opt/gitlab/backups/")]),s._v(" 目录下。如果您想改变这个位置，可以通过如下配置来指定一个新的路径（注意：此路径必须是主机上的一个目录，并且需要通过Docker卷挂载到容器中）：")]),s._v(" "),t("div",{staticClass:"language-ruby line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ruby"}},[t("code",[s._v("gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup_path'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/mnt/backup"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("strong",[s._v("备份频率和时间")])]),s._v(" "),t("p",[s._v("GitLab本身并不直接控制备份的频率或时间，这通常由外部调度器（如cron）来管理。但是，您可以在脚本中使用"),t("code",[s._v("gitlab-backup create")]),s._v("命令来触发备份。")]),s._v(" "),t("p",[t("strong",[s._v("自动清理旧备份")])]),s._v(" "),t("p",[s._v("您可以配置自动删除过期的备份文件，以避免磁盘空间被过多占用。以下是配置项示例，它表示只保留最近的5个备份文件：")]),s._v(" "),t("div",{staticClass:"language-ruby line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ruby"}},[t("code",[s._v("gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup_keep_time'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("604800")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 单位为秒, 这里表示7天")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("请注意，"),t("code",[s._v("backup_keep_time")]),s._v(" 配置项指的是创建备份后的时间间隔，在超过该时间间隔之后，备份文件将会被标记为可删除。实际上的删除操作是在新的备份创建时执行的。")]),s._v(" "),t("p",[t("strong",[s._v("备份压缩")])]),s._v(" "),t("p",[s._v("为了节省空间，您可以启用备份文件的压缩功能：")]),s._v(" "),t("div",{staticClass:"language-ruby line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ruby"}},[t("code",[s._v("gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup_tar_options'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'--gzip'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("strong",[s._v("使用S3或其他云存储进行备份")])]),s._v(" "),t("p",[s._v("如果您希望将备份文件上传到Amazon S3或其他支持的对象存储服务上，可以配置相关参数：")]),s._v(" "),t("div",{staticClass:"language-ruby line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ruby"}},[t("code",[s._v("gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup_upload_connection'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'provider'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'AWS'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'region'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'us-east-1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'aws_access_key_id'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'AKIAKIAKI'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'aws_secret_access_key'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'secret123'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup_upload_remote_directory'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'my-s3-bucket'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("请确保替换上述代码中的占位符为您自己的云存储凭据和信息。")]),s._v(" "),t("p",[t("strong",[s._v("应用更改")])]),s._v(" "),t("p",[s._v("修改完"),t("code",[s._v("gitlab.rb")]),s._v("文件后，请记得运行以下命令使配置生效：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" gitlab-ctl reconfigure\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("以上就是一些关于GitLab备份配置的关键点。根据您的具体需求调整配置，并确保定期测试备份和恢复过程，以保证其有效性。如果还有其他问题或者需要进一步的帮助，请随时告知！")]),s._v(" "),t("h4",{attrs:{id:"恢复步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#恢复步骤"}},[s._v("#")]),s._v(" 恢复步骤")]),s._v(" "),t("blockquote",[t("p",[s._v("当需要从备份中恢复时，请确保停止所有访问 GitLab 的流量，并且在恢复前停掉 GitLab 容器。")])]),s._v(" "),t("ol",[t("li",[t("p",[t("strong",[s._v("停止 GitLab 容器")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker stop gitlab-ce\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("执行恢复命令")])]),s._v(" "),t("p",[s._v("找到你想用来恢复的备份文件，它应该位于 "),t("code",[s._v("/srv/docker/gitlab/data/backups/")]),s._v("。然后，启动容器并立即进入容器执行恢复命令：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker start gitlab-ce "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it gitlab-ce gitlab-backup restore "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("BACKUP")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("timestamp_of_backup\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("把 "),t("code",[s._v("timestamp_of_backup")]),s._v(" 替换为实际的备份文件名（不包括扩展名）。例如，如果文件名为 "),t("code",[s._v("1672876800_gitlab_backup.tar")]),s._v("，那么你应该指定 "),t("code",[s._v("BACKUP=1672876800")]),s._v("。")])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("重启 GitLab")])]),s._v(" "),t("p",[s._v("恢复完成后，重新启动 GitLab 服务：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker restart gitlab-ce\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("p",[s._v("请务必在执行这些操作之前阅读官方文档，因为 GitLab 的版本更新可能会引入新的特性或更改现有的行为。此外，建议在非生产环境中测试备份和恢复过程，以确保一切按预期工作。")]),s._v(" "),t("p",[t("strong",[s._v("容器内恢复操作")])]),s._v(" "),t("p",[s._v("如果 exec 进入容器内部进行恢复数据，恢复前需要先停止puma和sidekiq服务。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("gitlab-ctl stop puma\ngitlab-ctl stop  sidekiq\ngitlab-ctl status\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# puma服务:是一个用于 Ruby 应用程序的简单、快速、多线程和高度并发的HTTP 1.1服务器。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sidekiq服务:存储用户在后台执行队列任务(异步执行)")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h2",{attrs:{id:"讨论区"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#讨论区"}},[s._v("#")]),s._v(" 讨论区")]),s._v(" "),t("blockquote",[t("p",[s._v("由于评论过多会影响页面最下方的导航，故将评论区做默认折叠处理。")])]),s._v(" "),t("details",{staticClass:"custom-block details"},[t("summary",[s._v("点击查看评论区内容，渴望您的宝贵建议~")]),s._v(" "),t("Vssue",{attrs:{title:s.$title,options:{locale:"zh"}}})],1)])}),[],!1,null,null,null);a.default=n.exports}}]);